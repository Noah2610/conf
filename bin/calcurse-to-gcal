#!/bin/bash

set -e
prog_name="$( basename "$0" )"

# https://stackoverflow.com/a/17841619
function join_by { local d=$1; shift; echo -n "$1"; shift; printf "%s" "${@/#/$d}"; }

function message {
  msg="$( join_by "\n  " "$prog_name" "$@" )"
  echo -e "$msg"
}

function error {
  msg="$( join_by "\n  " "$prog_name ERROR" "$@" "Exiting." )"
  (>&2 echo -e "$msg")
  exit 1
}

function validate_program_available {
  if ! which $1 &> /dev/null; then
    error "'${1}' program is not available."
  fi
}

validate_program_available calcurse
validate_program_available gcalcli

calendar_convert_script="ical-convert"
validate_program_available $calendar_convert_script

gcal_calendar="Calcurse"

calcurse_root="${HOME}/.calcurse"
calcurse_apts_root="${calcurse_root}/calendars"
calcurse_apts_profile_default="default"
calcurse_apts_profile="$1"
if [ -z "$calcurse_apts_profile" ];             then  calcurse_apts_profile="$CALCU_APTS_PROFILE";             fi
if [ -z "$calcurse_apts_profile" ];             then  calcurse_apts_profile="$( hostname )";                   fi
if [ "$calcurse_apts_profile" == "localhost" ]; then  calcurse_apts_profile="$calcurse_apts_profile_default";  fi
calcurse_apts_file="${calcurse_apts_root}/${calcurse_apts_profile}.apts"

if ! [ -f "$calcurse_apts_file" ]; then
  error "Calcurse calendar file '${calcurse_apts_file}' does not exist or is a directory."
fi

message "Deleting all existing events from Google Calendar '${gcal_calendar}'."
gcalcli --nocache --calendar "$gcal_calendar" --iamaexpert delete '*' 1> /dev/null
message "Exporting Calcurse calendar '${calcurse_apts_file}'," "adjusting values, and" "importing to Google Calendar '${gcal_calendar}'."
calcurse -c "$calcurse_apts_file" --export ical | $calendar_convert_script - | gcalcli --nocache --calendar "$gcal_calendar" import 1> /dev/null
message "Done!"
