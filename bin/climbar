#!/bin/bash

set -e

SCRIPT_NAME="$0"

function error {
  (2>&1 echo -e "$SCRIPT_NAME ERROR:\n$1\nExiting")
  exit 1
}

function is_available {
  which $1 &> /dev/null
}

function verify_available {
  is_available "$1" || error "'$1' is not available"
}

function send_signal {
  pkill -RTMIN+$SIGNAL i3blocks
}

function on_kill {
  [ -n "$CLIMER_PID"  ] && kill $CLIMER_PID
  [ -n "$OUTPUT_FILE" ] && (echo > $OUTPUT_FILE && send_signal)
}

trap on_kill SIGINT SIGTERM SIGKILL

verify_available "i3blocks"
verify_available "climer"

SIGNAL=2
OUTPUT_FILE="$HOME/.bar_output"
UPDATE_DELAY_S=0.05
FINAL_CLEAR_DELAY_S=5

climer $@ -w "$OUTPUT_FILE" &
CLIMER_PID=$!

echo $#
[ $# -eq 0 ] && exit 1

while true; do
  if ! kill -0 $CLIMER_PID &> /dev/null; then
    send_signal
    break
  fi
  send_signal
  sleep $UPDATE_DELAY_S
done

sleep ${FINAL_CLEAR_DELAY_S}s
echo > $OUTPUT_FILE
send_signal
